import{AmbientLight as e,BoxGeometry as t,Clock as i,LoadingManager as n,Mesh as a,MeshBasicMaterial as o,MeshLambertMaterial as r,PerspectiveCamera as s,Raycaster as c,Scene as l,SpotLight as d,TextureLoader as p,Vector2 as m,Vector3 as u,WebGLRenderer as k}from"three";import{GLTFLoader as h}from"three/addons/loaders/GLTFLoader.js";import w from"./LockedControls.js";import{isTicketCurrentlyDisplayed as f,toggleTicketOn as G}from"./ticket.js";import{tellPageLoaded as j}from"./splash.js";import{createFortuneOnTicket as Y}from"./fortunes.js";const g={camera:{defaultPosition:new u(-4.2,1.7,-3.5)},model:{position:new u(0,-2,0),scale:new u(2,2,2)},light:{spotlightItensity:3,spotlightColor:16774582,spotlightPos:new u(-8.4,3.4,-7),spotlightTarget:new u(-2.5,1,-.3),spotlightAngle:Math.PI/20,spotlightDistance:30,ambientIntensity:.03,ambientColor:16777215},shake:{intensity:new u(.03,.03,.03),minDurationMS:1e3},flicker:{startProbability:.005,onInterval:.1,timingFunc:()=>Math.floor(.07*Math.random())+.07,countFunc:()=>Math.floor(2*Math.random())+2},cameraSlide:{speed:4},ticketHitbox:{geometry:new t(.2,.11,.005),position:new u(-2.005,-.02,-.75),rotateY:.5},ticketSlide:{speed:4,initialPosition:new u(-1.82,-.051,-.45),finalPosition:new u(-1.945,-.051,-.65)},ticketMat:{urlPrefix:"assets/images/image-bank-back/background-card-",material:new r({color:14731686}),geometry:new t(.1,.005,.5),rotationY:.57}},y={currentShakeDuration:0,responseGenerated:!0,shakeEndHappened:!0,currentFlickerCount:0,slideCameraTowardDefault:!1,ticketSpawned:!1,flickerOn:!1,flickerTime:0,curFlickerOffInterval:g.flicker.timingFunc(),shakeDeltaVec:new u},b=new l,q=new i,S=new n,P=new c,M=new m,V=new p;var C=new h(S);const v=new k({alpha:!1}),L=new s(25,window.innerWidth/window.innerHeight,1,2e3);var T=new d(g.light.spotlightColor,g.light.spotlightItensity);const D=new e(g.light.ambientColor,g.light.ambientIntensity),F=(L.position.copy(g.camera.defaultPosition),v.setClearColor(0),v.setPixelRatio(window.devicePixelRatio),v.setSize(window.innerWidth,window.innerHeight),document.body.appendChild(v.domElement),new w(L,v.domElement));F.API.enabled=!0,C.load("assets/models/fixedangle.glb",e=>{e=e.scene;e.scale.copy(g.model.scale),e.position.copy(g.model.position),b.add(e)});C=new o({color:16711680});C.opacity=0,C.transparent=!0;const I=new a(g.ticketHitbox.geometry,C),x=(I.position.copy(g.ticketHitbox.position),I.rotateY(g.ticketHitbox.rotateY),b.add(I),g.ticketMat.material.roughness=1,new a(g.ticketMat.geometry,g.ticketMat.material));function E(){return!f()&&F.API.enabled&&!y.ticketSpawned&&document.querySelector(".cover").classList.contains("hidden")}function H(e){e=V.load(""+g.ticketMat.urlPrefix+e+"-map.png");g.ticketMat.material.map=e}function W(e){M.x=e.clientX/window.innerWidth*2-1,M.y=2*-(e.clientY/window.innerHeight)+1,P.setFromCamera(M,L),0<P.intersectObjects([I,x]).length&&y.ticketSpawned&&(G(),b.remove(x),y.ticketSpawned=!1,F.API.enabled=!1)}function R(e){" "===e.key&&E()&&(y.ticketSpawned=!0,y.currentShakeDuration=g.shake.minDurationMS/1e3,y.responseGenerated=!1,Y({callback:e=>{y.responseGenerated=!0,H(e.currentImageBack)}}))}function z(){var e=window.innerWidth,t=window.innerHeight;v.setSize(e,t),L.aspect=e/t,L.updateProjectionMatrix()}function O(e,t,i,n){return t.clone().sub(e).multiplyScalar(i*n)}function B(e){y.flickerTime+=e,0<y.currentFlickerCount?y.flickerOn&&y.flickerTime>=g.flicker.onInterval?(b.remove(D),y.flickerOn=!1,y.flickerTime=0):!y.flickerOn&&y.flickerTime>=y.curFlickerOffInterval&&(b.add(D),y.flickerOn=!0,y.flickerTime=0,--y.currentFlickerCount,y.curFlickerOffInterval=g.flicker.timingFunc()):Math.random()<g.flicker.startProbability&&(y.currentFlickerCount=g.flicker.countFunc())}function A(){var e,t=q.getDelta();e=t,0<y.currentShakeDuration||!y.responseGenerated?(y.shakeDeltaVec.random().subScalar(.5).multiply(g.shake.intensity),L.position.add(y.shakeDeltaVec),y.currentShakeDuration-=e,y.shakeEndHappened=!1):y.shakeEndHappened||(y.shakeEndHappened=!0,x.position.copy(g.ticketSlide.initialPosition),b.add(x),y.slideCameraTowardDefault=!0),B(t),e=t,x.position.distanceTo(g.ticketSlide.finalPosition)<=.01||(e=O(x.position,g.ticketSlide.finalPosition,g.ticketSlide.speed,e),x.position.add(e)),e=t,y.slideCameraTowardDefault&&(e=O(L.position,g.camera.defaultPosition,g.cameraSlide.speed,e),L.position.add(e),L.position.equals(g.camera.defaultPosition))&&(y.slideCameraTowardDefault=!1),F.update(t),v.render(b,L),requestAnimationFrame(A)}x.rotateY(g.ticketMat.rotationY),T.position.copy(g.light.spotlightPos),T.target.position.copy(g.light.spotlightTarget),T.angle=g.light.spotlightAngle,T.distance=g.light.spotlightDistance,T.penumbra=1,T.castShadow=!0,b.add(T.target),b.add(T),b.add(D),document.addEventListener("DOMContentLoaded",function(){[document.querySelector("#save-button"),document.querySelector("#discard-button")].forEach(e=>{e.addEventListener("click",()=>{F.API.enabled=!0})}),window.addEventListener("click",W),window.addEventListener("keydown",R),window.addEventListener("resize",z),S.onLoad=()=>{j(F)},A()});export{E as canTriggerEvent,H as setTicketMapToImage};